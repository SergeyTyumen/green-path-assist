
{% extends "layout.html" %}

{% block title %}{% if supplier %}Редактирование поставщика{% else %}Новый поставщик{% endif %} - CRM{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <a href="{{ url_for('suppliers') }}" class="inline-flex items-center text-sm font-medium text-muted-foreground hover:text-foreground">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Назад к поставщикам
            </a>
        </div>

        <h1 class="text-3xl font-bold tracking-tight mb-2">{% if supplier %}Редактирование поставщика{% else %}Новый поставщик{% endif %}</h1>
        <p class="text-muted-foreground mb-8">{% if supplier %}Обновите данные о поставщике.{% else %}Заполните информацию для добавления нового поставщика.{% endif %}</p>

        <form method="POST" action="{{ url_for('supplier_edit', supplier_id=supplier.id) if supplier else url_for('supplier_new') }}" id="supplier-form">
            <div class="bg-card p-6 rounded-lg shadow-sm border mb-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-muted-foreground mb-1">Название компании *</label>
                        <input type="text" id="name" name="name" value="{{ supplier.name if supplier else '' }}" required class="w-full px-3 py-2 border border-input rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-background text-foreground">
                    </div>
                    <div>
                        <label for="contact_person" class="block text-sm font-medium text-muted-foreground mb-1">Контактное лицо</label>
                        <input type="text" id="contact_person" name="contact_person" value="{{ supplier.contact_person if supplier else '' }}" class="w-full px-3 py-2 border border-input rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-background text-foreground">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-muted-foreground mb-1">Email</label>
                        <input type="email" id="email" name="email" value="{{ supplier.email if supplier else '' }}" class="w-full px-3 py-2 border border-input rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-background text-foreground">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-muted-foreground mb-1">Адрес / Город</label>
                        <input type="text" id="location" name="location" value="{{ supplier.location if supplier else '' }}" class="w-full px-3 py-2 border border-input rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-background text-foreground">
                    </div>
                </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="entity_type" class="block text-sm font-medium text-muted-foreground mb-1">Тип организации</label>
                        <select id="entity_type" name="entity_type" class="w-full px-3 py-2 border border-input rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-background text-foreground">
                            <option value="ИП" {% if supplier and supplier.entity_type == 'ИП' %}selected{% endif %}>ИП</option>
                            <option value="ООО" {% if supplier and supplier.entity_type == 'ООО' %}selected{% endif %}>ООО</option>
                            <option value="Частное лицо" {% if supplier and supplier.entity_type == 'Частное лицо' %}selected{% endif %}>Частное лицо</option>
                        </select>
                    </div>
                    {% if supplier %}
                    <div>
                        <label for="status" class="block text-sm font-medium text-muted-foreground mb-1">Статус</label>
                        <select id="status" name="status" class="w-full px-3 py-2 border border-input rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary bg-background text-foreground">
                           <option value="active" {% if supplier.status == 'active' %}selected{% endif %}>Активен</option>
                           <option value="on-hold" {% if supplier.status == 'on-hold' %}selected{% endif %}>Приостановлен</option>
                           <option value="inactive" {% if supplier.status == 'inactive' %}selected{% endif %}>Неактивен</option>
                        </select>
                    </div>
                    {% endif %}
                </div>
                
                <div>
                    <h3 class="text-sm font-medium text-muted-foreground mb-2">Телефоны</h3>
                    <div id="phones-container" class="space-y-3">
                        {% if phones %}
                            {% for phone in phones %}
                            <div class="flex items-center gap-2 phone-row">
                                <input type="tel" name="phone_number" value="{{ phone.number }}" class="w-full px-3 py-2 border border-input rounded-md bg-background" placeholder="Номер телефона">
                                <select name="phone_type" class="px-3 py-2 border border-input rounded-md bg-background">
                                    <option value="mobile" {% if phone.type == 'mobile' %}selected{% endif %}>Мобильный</option>
                                    <option value="landline" {% if phone.type == 'landline' %}selected{% endif %}>Городской</option>
                                </select>
                                <select name="phone_messenger" class="px-3 py-2 border border-input rounded-md bg-background">
                                    <option value="" {% if not phone.messenger or phone.messenger == 'none' %}selected{% endif %}>Мессенджер</option>
                                    <option value="whatsapp" {% if phone.messenger == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
                                    <option value="telegram" {% if phone.messenger == 'telegram' %}selected{% endif %}>Telegram</option>
                                    <option value="viber" {% if phone.messenger == 'viber' %}selected{% endif %}>Viber</option>
                                </select>
                                <button type="button" class="btn btn-icon btn-danger remove-phone-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                </button>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <button type="button" id="add-phone-btn" class="btn btn-secondary btn-sm mt-3">Добавить телефон</button>
                </div>

                <div>
                    <h3 class="text-sm font-medium text-muted-foreground mb-2">Категории</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                         {% set all_categories = ['Растения', 'Материалы для мощения', 'Сыпучие материалы', 'Оборудование для полива', 'Инструменты', 'Декор', 'Освещение', 'Удобрения'] %}
                         {% for cat in all_categories %}
                         <div class="flex items-center">
                             <input type="checkbox" id="cat_{{ cat }}" name="categories" value="{{ cat }}" {% if cat in (categories or []) %}checked{% endif %} class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                             <label for="cat_{{ cat }}" class="ml-2 block text-sm text-foreground">{{ cat }}</label>
                         </div>
                         {% endfor %}
                    </div>
                </div>

                 <div>
                    <h3 class="text-sm font-medium text-muted-foreground mb-2">Теги</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                         {% set all_tags = ['Собственное производство', 'Дилерская скидка', 'Удобный склад', 'Есть отсрочка', 'Быстрая доставка', 'Эксклюзивный поставщик'] %}
                         {% for tag in all_tags %}
                         <div class="flex items-center">
                             <input type="checkbox" id="tag_{{ tag }}" name="tags" value="{{ tag }}" {% if tag in (tags or []) %}checked{% endif %} class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                             <label for="tag_{{ tag }}" class="ml-2 block text-sm text-foreground">{{ tag }}</label>
                         </div>
                         {% endfor %}
                    </div>
                </div>
            </div>

            <input type="hidden" name="phones" id="phones-json">

            <div class="flex justify-end gap-4 mt-8">
                <a href="{{ url_for('suppliers') }}" class="btn btn-outline">Отмена</a>
                <button type="submit" class="btn btn-primary">
                    {% if supplier %}Сохранить изменения{% else %}Добавить поставщика{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const phonesContainer = document.getElementById('phones-container');
    const addPhoneBtn = document.getElementById('add-phone-btn');
    const form = document.getElementById('supplier-form');
    const phonesJsonInput = document.getElementById('phones-json');

    function createPhoneRow() {
        const row = document.createElement('div');
        row.classList.add('flex', 'items-center', 'gap-2', 'phone-row');
        row.innerHTML = `
            <input type="tel" name="phone_number" class="w-full px-3 py-2 border border-input rounded-md bg-background" placeholder="Номер телефона" required>
            <select name="phone_type" class="px-3 py-2 border border-input rounded-md bg-background">
                <option value="mobile" selected>Мобильный</option>
                <option value="landline">Городской</option>
            </select>
            <select name="phone_messenger" class="px-3 py-2 border border-input rounded-md bg-background">
                <option value="" selected>Мессенджер</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="telegram">Telegram</option>
                <option value="viber">Viber</option>
            </select>
            <button type="button" class="btn btn-icon btn-danger remove-phone-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </button>
        `;
        phonesContainer.appendChild(row);
    }

    addPhoneBtn.addEventListener('click', createPhoneRow);

    phonesContainer.addEventListener('click', function (e) {
        if (e.target.closest('.remove-phone-btn')) {
            e.target.closest('.phone-row').remove();
        }
    });

    form.addEventListener('submit', function (e) {
        const phones = [];
        const rows = phonesContainer.querySelectorAll('.phone-row');
        rows.forEach(row => {
            const number = row.querySelector('[name=phone_number]').value;
            const type = row.querySelector('[name=phone_type]').value;
            const messenger = row.querySelector('[name=phone_messenger]').value;
            if (number) {
                 phones.push({ number, type, messenger });
            }
        });
        phonesJsonInput.value = JSON.stringify(phones);
    });
});
</script>
{% endblock %}
