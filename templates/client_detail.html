{% extends "layout.html" %}

{% block title %}{{ client.name }} - Карточка клиента{% endblock %}

{% block content %}
<div class="p-6 space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-foreground">Карточка клиента</h1>
            <p class="text-muted-foreground mt-1">
                Полная информация о клиенте и история работы с заявкой
            </p>
        </div>
        <div class="flex gap-2">
            <form method="post" action="{{ url_for('client_edit', client_id=client.id) }}" class="inline">
                <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    {% include 'components/icons/edit.html' %}
                    <span class="ml-1">Редактировать</span>
                </button>
            </form>
        </div>
    </div>

    <div class="space-y-6">
        <!-- Client Info -->
        <div class="rounded-lg border bg-card text-card-foreground">
            <div class="p-6">
                <h3 class="text-lg font-semibold">Информация о клиенте</h3>
            </div>
            <div class="p-6 pt-0 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-muted-foreground">Имя</div>
                        <div class="font-medium">{{ client.name }}</div>
                    </div>

                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold {{ client.status_class }}">
                            {{ client.status_label }}
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center gap-2">
                        {% include 'components/icons/phone.html' %}
                        <span>{{ client.phone }}</span>
                    </div>

                    {% if client.email %}
                    <div class="flex items-center gap-2">
                        {% include 'components/icons/mail.html' %}
                        <span>{{ client.email }}</span>
                    </div>
                    {% endif %}
                </div>

                {% if client.address %}
                <div class="flex items-start gap-2">
                    {% include 'components/icons/map-pin.html' %}
                    <span>{{ client.address }}</span>
                </div>
                {% endif %}

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-muted-foreground">Бюджет</div>
                        <div class="font-medium">₽{{ "{:,.0f}".format(client.budget|float) if client.budget else '—' }}</div>
                    </div>
                    <div>
                        <div class="text-sm text-muted-foreground">Площадь</div>
                        <div class="font-medium">{{ client.project_area|default('—', true) }}м²</div>
                    </div>
                </div>

                <div>
                    <div class="text-sm text-muted-foreground mb-2">Услуги</div>
                    <div class="space-y-2">
                        {% if client.project_description %}
                        <div class="text-sm text-foreground bg-primary/10 p-3 rounded-lg">
                            {{ client.project_description }}
                        </div>
                        {% endif %}
                        <div class="flex flex-wrap gap-2">
                            {% for service in client.services %}
                            <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80">
                                {{ service_labels[service] }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Stages -->
        <div class="rounded-lg border bg-card text-card-foreground">
            <div class="p-6">
                <h3 class="text-lg font-semibold">Стадии работы с заявкой</h3>
            </div>
            <div class="p-6 pt-0">
                <div class="space-y-3">
                    {% for stage in stages %}
                    <form method="post" action="{{ url_for('stage_toggle', client_id=client.id, stage_id=stage.id) }}" class="inline">
                        <button type="submit" class="w-full text-left flex items-center justify-between p-3 rounded-lg border-2 transition-all cursor-pointer
                            {% if stage.completed %}
                                bg-green-50 border-green-200 text-green-800
                            {% elif stage.is_current %}
                                bg-blue-50 border-blue-200 text-blue-800
                            {% else %}
                                bg-gray-50 border-gray-200 text-gray-600
                            {% endif %}">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full flex items-center justify-center text-sm font-medium
                                    {% if stage.completed %}
                                        bg-green-500 text-white
                                    {% elif stage.is_current %}
                                        bg-blue-500 text-white
                                    {% else %}
                                        bg-gray-200 text-gray-600
                                    {% endif %}">
                                    {% if stage.completed %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                            <polyline points="22 4 12 14.01 9 11.01"/>
                                        </svg>
                                    {% elif stage.is_current %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
                                            <circle cx="12" cy="12" r="10"/>
                                            <polyline points="12 6 12 12 16 14"/>
                                        </svg>
                                    {% else %}
                                        {{ stage.stage_order }}
                                    {% endif %}
                                </div>
                                <span class="font-medium">{{ stage.stage_name }}</span>
                            </div>
                            {% if stage.completed and stage.completed_date %}
                            <div class="text-sm text-muted-foreground">
                                {{ stage.completed_date|format_date }}
                            </div>
                            {% endif %}
                        </button>
                    </form>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="rounded-lg border bg-card text-card-foreground">
            <div class="p-6">
                <h3 class="text-lg font-semibold">История общения</h3>
            </div>
            <div class="p-6 pt-0 space-y-4">
                <!-- Add new comment -->
                <div class="space-y-3 p-4 bg-muted/50 rounded-lg">
                    <form method="post" action="{{ url_for('comment_add', client_id=client.id) }}" class="space-y-3">
                        <div class="flex gap-2">
                            <select name="comment_type" class="flex h-10 w-40 items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                                <option value="note">Заметка</option>
                                <option value="call">Звонок</option>
                                <option value="meeting">Встреча</option>
                                <option value="email">Email</option>
                                <option value="message">Сообщение</option>
                            </select>
                        </div>
                        <textarea
                            name="content"
                            placeholder="Добавить комментарий..."
                            rows="3"
                            class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                        ></textarea>
                        <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-1">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Добавить комментарий
                        </button>
                    </form>
                </div>

                <hr class="border-t border-border" />

                <!-- Comments list -->
                {% if comments %}
                <div class="space-y-4">
                    {% for comment in comments %}
                    <div class="border-l-4 border-primary/20 pl-4 py-2">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="flex items-center gap-1 text-sm text-muted-foreground">
                                {% if comment.comment_type == 'call' %}
                                    {% include 'components/icons/phone.html' %}
                                {% elif comment.comment_type == 'meeting' %}
                                    {% include 'components/icons/user.html' %}
                                {% elif comment.comment_type == 'email' %}
                                    {% include 'components/icons/mail.html' %}
                                {% elif comment.comment_type == 'message' %}
                                    {% include 'components/icons/message-square.html' %}
                                {% else %}
                                    {% include 'components/icons/edit.html' %}
                                {% endif %}
                                <span class="capitalize">
                                    {% if comment.comment_type == 'note' %}
                                        Заметка
                                    {% elif comment.comment_type == 'call' %}
                                        Звонок
                                    {% elif comment.comment_type == 'meeting' %}
                                        Встреча
                                    {% elif comment.comment_type == 'email' %}
                                        Email
                                    {% else %}
                                        Сообщение
                                    {% endif %}
                                </span>
                            </div>
                            <span class="text-sm font-medium">{{ comment.author_name }}</span>
                            <span class="text-sm text-muted-foreground">
                                {{ comment.created_at|format_date }}
                            </span>
                        </div>
                        <div class="text-sm text-foreground leading-relaxed">
                            {{ comment.content }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-muted-foreground">
                    Пока нет комментариев к этому клиенту
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}